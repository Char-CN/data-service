<div style="width: 98%;">
	<form method="post" ds_index="form">
		<table style="border-collapse: separate; border-spacing: 10px; width: 100%;">
			<tbody>
				<tr>
					<td width="20%"><span>名称:</span></td>
					<td width="80%" ds_index="td_name"></td>
				</tr>
				<tr>
					<td width="20%"><span>备注:</span></td>
					<td width="80%" ds_index="td_remark"></td>
				</tr>
				<tr>
					<td colspan="2">以下是所有参数信息：</td>
				</tr>
			</tbody>
			<tbody ds_index="params"></tbody>
		</table>
	</form>
</div>
<script>
	$(function() {
		// 初始化参数、定义参数
		var queryString = '$queryString';
		var windowId = '$windowId';
		var id = $.ds.getQueryString(queryString, "id");
		var this_window = $("#" + windowId);

		// 刷新
		var a_reload = $('<a href="javascript:void(0)" class="icon-reload" title="刷新"></a>');
		this_window.parent().find(" .panel-tool").prepend(a_reload);
		a_reload.click(function() {
			$.ds.show('您正在刷新[' + this_window.window('options').title + ']');
			init();
		});

		var a_edit = $('<a href="javascript:void(0)" class="icon-edit" title="修改备注"></a>');
		this_window.parent().find(" .panel-tool").prepend(a_edit);
		a_edit.click(function() {
			this_window.DSFind("remark").textbox('readonly', false);
		});

		var a_save = $('<a href="javascript:void(0)" class="icon-save" title="保存"></a>');
		this_window.parent().find(" .panel-tool").prepend(a_save);
		a_save.click(function() {
			var configBody = { };
			configBody.id = id;
			configBody.remark = this_window.DSFind("remark").textbox("getValue");
			$.ajax({
				type : "post",
				url : $.ds.url.save_config_remark,
				data : JSON.stringify(configBody),
				contentType : "application/json",
				dataType : "json",
				success : function(data) {
					$.ds.show(data.message);
					this_window.DSFind("remark").textbox('readonly');
				},
				error : function(XMLHttpRequest, textStatus, errorThrown) {
					$.ds.show('保存失败！<br>status：' + XMLHttpRequest.status + '<br>state：' + XMLHttpRequest.readyState + '<br>text：' + (textStatus || errorThrown));
				}
			});
		});

		// 执行
		var a_run = $('<a href="javascript:void(0)" class="icon-run"></a>');
		this_window.parent().find(" .panel-tool").prepend(a_run);
		a_run.click(function() {
			run();
		});

		var run_task_name = "";
		var run = function() {
			if (run_task_name != "") {
				$.ds.alert('您已经提交任务，若需要再提交一次，请关闭执行任务窗口重新打开！');
				return;
			}
			$.ds.show('执行成功,如果数据量大请您耐心等待');
			// 执行前的检查
			if (!this_window.find(" form").form('validate')) {
				$.ds.show('您填写的内容不正确，请检查。');
				return false;
			}
			// 获取参数
			var params = "?config_id=" + id;
			this_window.DSFind('params').find('tr').each(function() {
				try {
					var key = $(this).find('td:eq(0)').text();
					var value = $(this).find('td:eq(1)').DSFind('key_value').textbox('getValue');
					params += "&" + $.ds.getCustomKey(key) + "=" + value;
				} catch (e) {
				}
			});
			// 执行任务
			var url = $.ds.url.add_task + params;
			$.post(url, function(data) {
				if (data.status == 200) {
					// 此时的message是taskName
					$.ds.commons.openTaskLog(data.message);
					run_task_name = data.message;
				} else {
					$.ds.alert(data.message);
				}
			});
		};

		// 初始化
		var init = function() {
			this_window.DSFind("td_name").empty();
			this_window.DSFind("td_remark").empty();
			var input_id = $('<input type="hidden">').DSAdd('id');
			this_window.DSFind("td_name").append(input_id);
			var te = $('<input>').DSAdd('name');
			this_window.DSFind("td_name").append(te);
			var te_remark = $('<input>').DSAdd('remark');
			this_window.DSFind("td_remark").append(te_remark);
			te.textbox({
				required : true,
				readonly : true,
				validateOnCreate : false,
				validateOnBlur : true,
				validType : [ 'nospace' ],
				width : "100%",
				multiline : false
			});
			te_remark.textbox({
				readonly : true,
				validateOnCreate : false,
				validateOnBlur : true,
				validType : [],
				width : "100%",
				height : 55,
				multiline : true
			});
			// 获取该配置的信息以及详细信息
			var url = $.ds.url.config_by_id + "?id=" + id;
			$.post(url, function(data) {
				this_window.DSFind("details").empty();
				this_window.DSFind("id").val(data.id);
				this_window.DSFind("name").textbox('initValue', data.configName);
				this_window.DSFind("remark").textbox('initValue', data.remark);
			});
			// 获取所有参数
			var url = $.ds.url.get_params + "?id=" + id;
			$.post(url, function(data) {
				var rst = eval(data);
				this_window.DSFind("params").empty();
				var tbody = this_window.DSFind("params");
				var params_str = "?id=" + id;

				var len = rst.params.length == 0 ? 1 : rst.params.length;
				var height = 120 + 60 + len * 33;
				if (height > $(window).height()) {
					height = $(window).height();
				}
				this_window.dialog('resize', {
					height : height
				});
				for ( var i in rst.params) {
					var te = $('<input>').DSAdd('key_value');
					var tr = $("<tr></tr>");
					var td1 = $("<td>" + rst.params[i] + "</td>");
					var td2 = $("<td></td>").append(te);
					tbody.append(tr.append(td1).append(td2));
					te.textbox({
						validateOnCreate : false,
						validateOnBlur : true,
						width : "100%",
						multiline : false
					});
					params_str += "&" + $.ds.getCustomKey(rst.params[i]) + "=?";
				}
				if (rst.params.length == 0) {
					tbody.append('<tr><td width="20%"></td><td width="80%">没有任何参数。</td></tr>');
				}
			});
		};

		init();
	});
</script>