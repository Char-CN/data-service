<table>
	<tr>
		<td width="70">任务名称：</td><td ds_index="taskName"></td>
	</tr>
	<tr>
		<td>参数信息：</td><td></td>
	</tr>
	<tr>
		<td></td><td ds_index="params"></td>
	</tr>
	<tr>
		<td>备注说明：</td><td ds_index="remark"></td>
	</tr>
	<tr>
		<td>任务状态：</td><td ds_index="status"></td>
	</tr>
	<tr>
		<td>日志信息：</td><td></td>
	</tr>
	<tr>
		<td></td><td ds_index="log"></td>
	</tr>
</table>
<script>
	$(function() {
		// 初始化参数、定义参数
		var queryString = '$queryString';
		var windowId = '$windowId';
		var taskName = $.ds.getQueryString(queryString, "taskName");
		var this_window = $("#" + windowId);
		// 		this_window.DSFind("taskName").text(taskName);
		var left = ($(window).width() - 900) / 2;
		this_window.dialog('resize', {
			height : 500,
			width : 900,
			left : 0,
			top : 100
		});
		// 刷新
		var a_reload = $('<a href="javascript:void(0)" class="icon-reload"></a>');
		this_window.parent().find(" .panel-tool").prepend(a_reload);
		a_reload.click(function() {
			$.ds.show('您正在刷新[' + this_window.window('options').title + ']');
			init();
		});
		var init = function() {
			this_window.DSFind("taskName").html($.ds.icon.loading + 'loading...');
			this_window.DSFind("remark").html($.ds.icon.loading + 'loading...');
			this_window.DSFind("params").html($.ds.icon.loading + 'loading...');
			this_window.DSFind("status").html($.ds.icon.loading + 'loading...');
			this_window.DSFind("log").html('');
			skipRowNumber = 0;
			getLog();
			$.post($.ds.url.find_task_by_name, {
				taskName : taskName
			}, function(data) {
				try {
					this_window.DSFind("taskName").html(data.taskName);
					this_window.DSFind("remark").html(data.remark);
					var content = "";
					var params = data.params.split(",");
					for (var i in params) {
						if (content != "") {
							content += "<br/>";
						}
						content += params[i];
					}
					this_window.DSFind("params").html(content);
					var status = $.ds.commons.getStatus(data.status);
					this_window.DSFind("status").html(status);
				} catch (e) {
				}
			});
		};

		var interval_code = undefined;
		var skipRowNumber = 0;
		var getLog = function() {
			this_window.DSFind("taskName").html($.ds.icon.loading + 'loading...');
			this_window.DSFind("remark").html($.ds.icon.loading + 'loading...');
			this_window.DSFind("params").html($.ds.icon.loading + 'loading...');
			this_window.DSFind("status").html($.ds.icon.loading + 'loading...');
			$.post($.ds.url.find_task_log_by_name, {
				taskName : taskName,
				skipRowNumber : skipRowNumber
			}, function(data) {
				try {
					// task info
					this_window.DSFind("taskName").html(data.task.taskName);
					this_window.DSFind("remark").html(data.task.remark);
					var content = "";
					var params = data.task.params.split(",");
					for (var i in params) {
						if (content != "") {
							content += "<br/>";
						}
						content += params[i];
					}
					this_window.DSFind("params").html(content);
					var status = $.ds.commons.getStatus(data.task.status);
					this_window.DSFind("status").html(status);
					// log
					this_window.DSFind("log").append(data.logModel.content);
					var status = $.ds.commons.getStatus(data.task.status);
					if (status == "正在执行" || status == "等待执行" || skipRowNumber != data.logModel.total) {
						skipRowNumber = data.logModel.total;
						interval_code = setTimeout(getLog, 5000);
					}
				} catch (e) {
				}
			});
		};

		init();
	});
</script>