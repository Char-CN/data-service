<ul id="center_ul" class="dsul"></ul>
<script>
	$(function() {
		var queryString = '$queryString';
		var windowId = '$windowId';
		var id = $.ds.getQueryString(queryString, "id");
		var this_window = $("#" + windowId);
		var this_ul = this_window.find("#center_ul");
		// 删除所有menu，因为menu是被easyui放在body中的。
		$("#center_menu").remove();
		$("#center_menu_sort").remove();
		$("#center_menu_save_cancel").remove();

		var lock_menu = false;
		var center_choose_li_id = "";
		var sortable = Sortable.create(this_ul[0]);

		this_window.bind('contextmenu', function(e) {
			bindContextMenu(e);
		});

		var bindContextMenu = function(e) {
			lock_menu = true;
			e.preventDefault();
			var showMenu = $('#center_menu').menu('show', {
				left : e.pageX,
				top : e.pageY
			});
		};

		var center_menu = $('<div id="center_menu"></div>');
		center_menu.appendTo(this_window);
		center_menu.menu({
			onHide : function() {
				lock_menu = false;
			}
		});

		center_menu.menu('appendItem', {
			text : '执行',
			iconCls : 'fa fa-play-circle fa-1x',
			onclick : function() {
				if (center_choose_li_id == "") {
					return $.dsmessager.show('请选择一项配置执行!');
				}
				var id = center_choose_li_id;
				var title = this_ul.find("li[ds_index='" + center_choose_li_id + "']").attr("ds_title");
				$.ds.commons.openWindow("center_run_config_" + id, $.ds.icon.run, title, "runconfig.html", "id=" + id);
				return $.dsmessager.show('执行 ' + title);
			}
		});

		center_menu.menu('appendItem', {
			text : '新增配置项',
			iconCls : 'fa fa-plus-circle fa-1x',
			disabled : false,
			onclick : function() {
				$.ds.commons.openWindow("center_add_config", $.ds.icon.add , "新增配置项", "addconfig.html", "group_id=" + id);
			}
		});

		center_menu.menu('appendItem', {
			text : '修改',
			iconCls : 'fa fa-edit fa-1x',
			onclick : function() {
				if (center_choose_li_id == "") {
					return $.dsmessager.show('请选择一项配置进行修改!');
				}
				var id = center_choose_li_id;
				var title = this_ul.find("li[ds_index='" + center_choose_li_id + "']").attr("ds_title");
				openConfig(id, title);
				return $.dsmessager.show('修改!');
			}
		});

		center_menu.append($('<div class="menu-sep"></div>'));

		center_menu.menu('appendItem', {
			text : '自定义排序',
			iconCls : 'fa fa-list fa-1x',
			onclick : function() {
				this_window.unbind('contextmenu');
				this_window.bind('contextmenu', function(e) {
					e.preventDefault();
					$('#center_menu_save_cancel').menu('show', {
						left : e.pageX,
						top : e.pageY
					});
				});
				sortable.option("disabled", false);
				return $.dsmessager.show('您已经开启了自定义排序功能，请拖动列表，然后右键→保存!');
			}
		});

		center_menu.menu('appendItem', {
			text : '刷新',
			iconCls : 'fa fa-refresh fa-1x',
			onclick : function() {
				init();
			}
		});

		var menuSaveCancel = $('<div id="center_menu_save_cancel"></div>');
		menuSaveCancel.appendTo(this_window).menu({});
		menuSaveCancel.menu('appendItem', {
			text : '保存',
			iconCls : 'fa fa-save fa-1x',
			onclick : function() {
				this_window.unbind('contextmenu');
				this_window.bind('contextmenu', function(e) {
					bindContextMenu(e);
				});
				sortable.option("disabled", true);
				return $.dsmessager.show('您保存了本次自定义排序操作!');
			}
		}).menu('appendItem', {
			text : '取消',
			iconCls : 'fa fa-remove fa-1x',
			onclick : function() {
				this_window.unbind('contextmenu');
				this_window.bind('contextmenu', function(e) {
					bindContextMenu(e);
				});
				sortable.option("disabled", true);
				return $.dsmessager.show('您取消了本次自定义排序操作!');
			}
		});

		var openConfig = function(_id, title) {
			$.ds.commons.openWindow("center_add_config_" + _id, $.ds.icon.edit, title, "addconfig.html", "id=" + _id + "&group_id=" + id);
		};

		var init = function() {
			lock_menu = false;
			center_choose_li_id = "";
			sortable.option("disabled", true);
			var url = $.ds.url.configs_by_group_id + "?id=" + id;
			$.post(url, function(data) {
				this_ul.empty();
				var rst = eval(data);
				if (rst.length != 0) {
					for ( var i in rst) {
						var li = $('<li class="dsli" ds_index="'+rst[i].id+'" ds_title="'+rst[i].configName+'">');
						li.append('<i class="fa fa-cube fa-3x" aria-hidden="true"></i>');
						li.append('<span>' + rst[i].configName + '</span>');
	                    var _time = null;
						li.bind('dblclick', {
							id : rst[i].id,
							title : rst[i].configName
						}, function(d) {
							clearTimeout(_time);
							openConfig(d.data.id, d.data.title);
						});
						li.bind('click', {
							id : rst[i].id,
							title : rst[i].configName
						}, function(d) {
							clearTimeout(_time);
							_time = setTimeout(function(){
								$.ds.commons.openWindow("center_run_config_" + d.data.id, $.ds.icon.run , d.data.title, "runconfig.html", "id=" + d.data.id);
	                        }, 300);
						});
						li.hover(function() {
// 							$(this).css("background", "#e6e6e6");
// 							$(this).css("color", "00438a");
							center_choose_li_id = $(this).attr('ds_index');
						}, function() {
// 							$(this).css("background", "");
// 							$(this).css("color", "");
							if (lock_menu == false) {
								center_choose_li_id = "";
							}
						});
						this_ul.append(li);
					}
				}
				return $.dsmessager.show('加载[' + rst.length + ']条配置。');
			});
		};

		init();
	});
</script>