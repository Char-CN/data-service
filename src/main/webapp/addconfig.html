<form method="post">
	<table style="border-collapse: separate; border-spacing: 10px; width: 100%;">
		<tr>
			<td width="20%">数据源:</td>
			<td width="80%" ds_index="td_datasource"></td>
		</tr>
		<tr>
			<td width="20%">名称:</td>
			<td width="80%" ds_index="td_name"></td>
		</tr>
		<tr>
			<td colspan="2">以下是配置所有的详细信息：</td>
		</tr>
		<tr>
			<td colspan="2">
				<div>
					<ul ds_index="details" class="dsul"></ul>
				</div>
			</td>
		</tr>
	</table>
</form>
<script>
	$(function() {
		// 初始化参数
		var queryString = '$queryString';
		var windowId = '$windowId';
		var id = $.ds.getQueryString(queryString, "id");
		var this_window = $("#" + windowId);
		if (id == null) {
			$.dsmessager.show("您正在新增配置项。");
		} else {
			$.dsmessager.show('您正在修改[' + this_window.window('options').title + "]");
		}

		var sortable = Sortable.create(this_window.DSFind("details")[0]);
		// 增加window的tool
		// 执行
		var a_play = $('<a href="javascript:void(0)" class="icon-play"></a>');
		this_window.parent().find(" .panel-tool").prepend(a_play);
		a_play.click(function() {
			$.dsmessager.show('执行');
		});
		// 刷新
		var a_reload = $('<a href="javascript:void(0)" class="icon-reload"></a>');
		this_window.parent().find(" .panel-tool").prepend(a_reload);
		a_reload.click(function() {
			$.dsmessager.show('您正在刷新[' + this_window.window('options').title + ']');
			init();
		});
		// 排序
		var a_sort = $('<a href="javascript:void(0)" class="icon-orderby"></a>');
		this_window.parent().find(" .panel-tool").prepend(a_sort);
		a_sort.click(function() {
			sortable.option("disabled", false);
			$.messager.confirm('确定', '您确定要开启排序功能吗？开启后，请拖拽详情面板，排序后请保存。', function(r){
				if (r){
					$.dsmessager.show('您已经开启排序功能，请拖动配置详情。');
				} else {
					$.dsmessager.show('您已经取消排序。');
				}
			});
		});
		// 保存
		var a_save = $('<a href="javascript:void(0)" class="icon-save"></a>');
		this_window.parent().find(" .panel-tool").prepend(a_save);
		a_save.click(function() {
			sortable.option("disabled", true);
			// 保存前的检查
			if (!this_window.find(" form").form('validate')) {
				$.dsmessager.show('您填写的内容不正确，请检查。');
				return false;
			}
			// 不允相同key
// 			var lis = this_window.DSFind("details").find(" li");
// 			var map = new $.ds.HashMap();
// 			for (var i in lis) {
// 				var key = $(lis[i]).DSFind("key").textbox("getValue");
// 				var values = $(lis[i]).DSFind("values").textbox("getValue");
// 				if (map.containsKey(key)) {
// 					return $.dsmessager.show('有相同的key，请删除后再保存');
// 				}
// 				map.put(key, { values : values , datasourceId : 1});
// 			}
			$.dsmessager.show('保存');
		});

		// 初始化
		var init = function() {
			sortable.option("disabled", true);
			// 新增文本框
			this_window.DSFind("td_datasource").empty();
			this_window.DSFind("td_datasource").append($('<select style="width: 100%"></select>').DSAdd('datasource'));
			this_window.DSFind("td_name").empty();
// 			var te = $("<input>");
// 			this_window.find(" form .td_name").append('<input name="name" style="width: 100%;" class="easyui-validatebox" type="text" data-options="required:true,validType:[\'nospace\']" />');
			var te = $('<input>').DSAdd('name');
			this_window.DSFind("td_name").append(te);
			te.textbox({
				required : true,
				validateOnCreate : false,
				validateOnBlur : true,
				validType : ['nospace'],
				width : "100%",
				multiline : false
			});
			$.ajax({
				url : $.ds.url.datasource_all,
				type : 'post',
				async : false,
				success : function(data) {
// 					var select = this_window.find(" form .td_datasource select[ds_index='datasource']");
// 					var select = $.DSFind(this_window, "datasource");
					var select = this_window.DSFind("datasource");
					for ( var i in data) {
						var sel = "";
						var op = $('<option value="' + data[i].id + '" ' + sel +'>' + data[i].databaseName + '[' + data[i].title + ']</option>');
						select.append(op);
					}
					select.combobox({
						editable : false,
						panelMaxHeight : 88
					});
				},
				fail : function() {
					$.dsmessager.show("出现莫名失败。");
				}
			});
			// 新增
			if (id == null) {
				//$.dsmessager.show("您正在新增配置项。");
				addDetailPanel();
			}
			// 修改
			else {
				//$.dsmessager.show("您正在修改配置项。");
				var url = $.ds.url.config_by_id + "id=" + id;
				$.post(url, function(data) {
					this_window.DSFind("details").empty();
// 					this_window.find(" form input[name='name']").val(data.configName).validatebox('isValid');
					this_window.DSFind("datasource").combobox('select', data.datasourceId);
					this_window.DSFind("name").textbox('initValue', data.configName);
					for ( var i in data.list) {
						addDetailPanel(data.list[i].key, data.list[i].values);
					}
				});
			}
		};
		
		var addDetailCount = 1;
		var addDetailPanel = function(key, values) {
			var index = addDetailCount;
			var title = "";
			if (key == undefined) {
				title = "新增配置_" + addDetailCount;
			} else {
				title = '配置详情_' + addDetailCount;
			}
			addDetailCount ++;
			var details = this_window.DSFind("details");
			var te = $('<input ds_index="key" index="' + index + '">');
			var te2 = $('<input ds_index="values">');
			var pan = $('<div></div>');
			details.append($('<li ds_index="' + index + '"></li>').append(pan));
			pan.panel({
				border : true,
				// bodyCls: 'padding-10px',
				cls : 'margin-top-10px',
				collapsible : true,
				title : title,
				width : details.width(),
				tools : [ {
					iconCls : 'icon-add',
					handler : function() {
						sortable.option("disabled", false);
						addDetailPanel();
					}
				}, {
					iconCls : 'icon-remove',
					handler : function() {
						var dom = $(this);
						$.messager.confirm('确定', '您确定要删除该详情吗?', function(r){
							if (r) {
								pan.panel('destroy');
							}
						});
					}
				} ]
			});
			var tb = $('<table style="width:100%;"><tr style="width:100%;"><td style="width:20%;">key</td><td style="width:80%;"></td></tr><tr style="width:100%;"><td style="width:20%;">values</td><td style="width:80%;"></td></tr><table>');
			pan.append(tb);
			tb.find("tr").eq(0).find("td").eq(1).append(te);
			tb.find("tr").eq(1).find("td").eq(1).append(te2);
			te.textbox({
				required : true,
				validateOnCreate : false,
				validateOnBlur : true,
				validType : ['nospace', 'onlyValue["index","ds_index","key"]'],
				width : "100%",
				multiline : false,
				value : key,
				onChange : function(newValue, oldValue) {
					$(this).textbox('validate');
				}
			});
			te2.textbox({
				required : true,
				validateOnCreate : false,
				validateOnBlur : true,
				validType : [],
				width : "100%",
				height : 200,
				multiline : true,
				value : values
			});
		};
		
		init();
	});
</script>