<div style="width: 98%;">
	<form method="post" ds_index="form">
		<table style="border-collapse: separate; border-spacing: 10px; width: 100%;">
			<tbody>
				<tr>
					<td width="20%"><span>数据源:</span></td>
					<td width="80%" ds_index="td_datasource"></td>
				</tr>
				<tr>
					<td width="20%"><span>名称:</span></td>
					<td width="80%" ds_index="td_name"></td>
				</tr>
				<tr>
					<td colspan="2">以下是配置所有的参数信息：</td>
				</tr>
			</tbody>
			<tbody ds_index="params"></tbody>
			<tbody>
				<tr>
					<td colspan="2">以下是配置所有的详细信息：</td>
				</tr>
				<tr>
					<td colspan="2">
						<div>
							<ul ds_index="details" class="dsul"></ul>
						</div>
					</td>
				</tr>
			</tbody>
		</table>
	</form>
</div>
<script>
	$(function() {
		// 初始化参数、定义参数
		var queryString = '$queryString';
		var windowId = '$windowId';
		var id = $.ds.getQueryString(queryString, "id");
		var this_window = $("#" + windowId);

		// 执行
		var a_run = $('<a href="javascript:void(0)" class="icon-run"></a>');
		this_window.parent().find(" .panel-tool").prepend(a_run);
		a_run.click(function() {
			$.messager.confirm('确定', '您确定要保存该配置项吗?', function(r) {
				if (r) {
					// 保存前的检查
					if (!this_window.find(" form").form('validate')) {
						$.dsmessager.show('您填写的内容不正确，请检查。');
						return false;
					}

					var url = $.ds.url.get_config + "?id=" + id;
					$.post(url, function(data) {
						var rst = eval(data);
						this_window.DSFind("grid").each(function(){
							alert(JSON.stringify(rst.details[$(this).attr('key')].values));
							var values = rst.details[$(this).attr('key')].values[0];
							var keys = $.ds.getKeys(values);
							for (var i in keys) {
								alert(JSON.stringify(keys[i]));
// 								alert(JSON.stringify(rst.details[i]));
							}
						});
					});

					$.dsmessager.show('执行');
				}
			});
		});

		// 初始化
		var init = function() {
			// 新增文本框
			this_window.DSFind("td_datasource").empty();
			this_window.DSFind("td_datasource").append($('<select style="width: 100%"></select>').DSAdd('datasource'));
			this_window.DSFind("td_name").empty();
			var input_id = $('<input type="hidden">').DSAdd('id');
			this_window.DSFind("td_name").append(input_id);
			var te = $('<input>').DSAdd('name');
			this_window.DSFind("td_name").append(te);
			te.textbox({
				required : true,
				readonly : true,
				validateOnCreate : false,
				validateOnBlur : true,
				validType : [ 'nospace' ],
				width : "100%",
				multiline : false
			});
			$.ajax({
				url : $.ds.url.datasource_all,
				type : 'post',
				async : false,
				success : function(data) {
					var select = this_window.DSFind("datasource");
					for ( var i in data) {
						var sel = "";
						var op = $('<option value="' + data[i].id + '" ' + sel +'>' + data[i].databaseName + '[' + data[i].title + ']</option>');
						select.append(op);
					}
					select.combobox({
						readonly : true,
						panelMaxHeight : 88
					});
				},
				fail : function() {
					$.dsmessager.show("出现莫名失败。");
				}
			});
			var url = $.ds.url.config_by_id + "?id=" + id;
			$.post(url, function(data) {
				this_window.DSFind("details").empty();
				// 					this_window.find(" form input[name='name']").val(data.configName).validatebox('isValid');
				this_window.DSFind("datasource").combobox('select', data.datasourceId);
				this_window.DSFind("id").val(data.id);
				this_window.DSFind("name").textbox('initValue', data.configName);
				if (data.list.length == 0) {
					addDetailPanel();
				} else {
					for ( var i in data.list) {
						addDetailPanel(data.list[i].key, data.list[i].values);
					}
				}
			});
			var url = $.ds.url.get_params + "?id=" + id;
			$.post(url, function(data) {
				var rst = eval(data);
				this_window.DSFind("params").empty();
				var tbody = this_window.DSFind("params");
				for ( var i in rst.params) {
					var te = $('<input>').DSAdd('key_value');
					var tr = $("<tr></tr>");
					var td1 = $("<td>" + rst.params[i] + "</td>");
					var td2 = $("<td></td>").append(te);
					tbody.append(tr.append(td1).append(td2));
					te.textbox({
						required : true,
						validateOnCreate : false,
						validateOnBlur : true,
						validType : [ 'nospace' ],
						width : "100%",
						multiline : false
					});
				}
			});
		};

		// 增加详情面板
		var addDetailPanel = function(key, values) {
			var details = this_window.DSFind("details");
			var te2 = $('<input ds_index="values">');
			var pan = $('<div ds_index="panel"></div>');
			details.append($('<li"></li>').append(pan));
			pan.panel({
				border : true,
				// bodyCls: 'padding-10px',
				cls : 'margin-top-10px',
				collapsible : true,
				title : key,
				width : details.width()
			});
			pan.append(te2);
			te2.textbox({
				required : true,
				validateOnCreate : false,
				validateOnBlur : true,
				validType : [],
				width : "100%",
				height : 200,
				multiline : true,
				value : values
			});
			var grid = $('<table ds_index="grid" key="'+key+'"></table>');
			pan.append(grid);
			grid.datagrid({});
		};

		init();
	});
</script>